# Development

After cloning this repo, install all dependencies and build:

```sh
npm install
npm run build
```

## Repo structure

All MAJC source code is housed under the `packages` directory:

- `./core`
  - Contains all core shared functionality used to build the other framework-specific sub-packages
- `./heyapi`
  - Auto-generated code containing a fetch client and all of the data structures for the MARS APIs defined in `./heyapi/mars.yml`
- `./iife`
  - A lightweight IIFE wrapper around the `core` sub-package exposed as a `renderPlacement` function
- `./react`
  - A React-specific wrapper around the `core` sub-package containing a `MozAdsPlacement` component as well as related hooks
- `./examples`
  - Examples of different kinds of apps using MAJC


## Linting

This repository is linted using `eslint`. To run the linter:

```sh
npm run lint
```

Or, to fix issues that can be automatically resolved:

```sh
npm run lint:fix
```

## Pre-commit hooks

Husky manages all pre-commits via the `.husky/pre-commit` file. Currently, the only pre-commit hook runs `npm run build` and adds any changes in `./dist` to the commit.

### Disabling hooks locally

If you want to disable pre-commit hooks locally for any reason, set the `HUSKY=0` environment variable or preface `git commit`:

```sh
HUSKY=0 git commit -m "Your commit message"
```

## Build process

The build process is what allows our source code in `packages/` to be compacted into a small set of "minified" `.js` and `.mjs` files which can then be used in other projects.

MAJC's build process is handled primarily through [`tsup`](https://github.com/egoist/tsup) and is configured via a top-level `tsup.config.ts` file. All bundled dist files created by the build process can be found in `dist/`.

Currently, we have tsup configured with splitting enabled. As a result, you will also see some `chunk-{someHash}.js` files in `dist/`. These should not be imported or referenced directly by users of this library and just contain code which is referenced across multiple different dist files. This process of code splitting reduces duplicate code, overall bundle size, and helps processes like (treeshaking)[https://developer.mozilla.org/en-US/docs/Glossary/Tree_shaking] work more effectively.

### Build validation

At the end of the build process, a validation step is performed to verify that the files we expect to come out of the build process are properly created in our output directory.

In `tsup.config.ts`, you fill find an `expectedBuildOutput` const sitting at the top of the file. This object defines what the expected output should be. A description of this object's attributes can be found in the interface definition in `scripts/validateBuild.ts`.

Validation logic is handled by a `process.on('beforeExit', (...) => {...})` hook at the end of `tsup.config.ts`.

**Note**: A dry-run of this build process is performed during CI. As a result, any failure that occurs in the build validation will cause a failure in CI. This prevents us from merging code that fails to build.

## Example apps

- IIFE
  - `npm run example:iife`
- React
  - `npm run example:react`

NOTE: When testing local changes, be sure to re-build via `npm run build` to ensure the example apps are referencing the latest changes.

### Example React App and CI dependencies

As part of CI, we validate that the Example React App can build successfully. This is not so much to verify that our example is in a working condition (although it is a nice side-effect), but rather verify that MAJC will not cause build errors in an application that implements it. As a result, developers must make sure the example is always in a build-able state when opening a PR.

## Updating MARS API definitions

All of the code in the `packages/heyapi` sub-package is auto-generated by the API definitions in [`openapi.yml`](https://github.com/mozilla-services/mars/blob/main/openapi/openapi.yml) from the [mozilla-services/mars](https://github.com/mozilla-services/mars) repo. To pull in the latest version of the API definitions and re-generate an updated fetch client and data structures:

```sh
npm run update:mars-api
```

Note: This will only be possible for internal Mozillians who have access to the MARS repo.

## End-to-end testing with Playwright

We use [Playwright](https://playwright.dev/) for end-to-end/view testing. It loads up our example
apps and make sure they work correctly cross-browser and cross-device from a user-facing perspective.

To run the tests on the command line:

```sh
npm run playwright
```

This will start up the example apps if they aren't already running, run through the tests in a headless
browser, and open an interactive html report in your browser when its finished.

Some very useful additional modes:

```sh
# Record traces. Click a test case in the HTML report to see a detailed trace, with playback timeline and UI screenshots.
npm run playwright -- --trace on
# Run tests in Playwright's UI, with test controls, locator picker, watch mode, and more.
npm run playwright -- --ui
# Run the tests with an actual browser so you can watch Playwright interact with the page.
npm run playwright -- --headed
# Run the tests with specific browsers.
npm run playwright -- --project webkit --project firefox
# Run specific tests by filename, directory, filename keywords, or title.
npm run playwright -- iife.spec.ts
npm run playwright -- tests/subdirectory/
npm run playwright -- react angular
npm run playwright -- -g 'should display the ad'
```
